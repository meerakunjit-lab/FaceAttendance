<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MPPL Attendance — Camera Scan</title>
<style>
body{margin:0;background:#03060a;color:#cfeff6;font-family:Segoe UI;}
header{padding:16px;border-bottom:1px solid #033;text-align:center;}
.center-container{
  position:relative;
  width:640px;
  height:480px;
  margin:20px auto 0 auto;
}
video, canvas{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  border-radius:12px;
}
.status{margin-top:10px;font-size:14px;text-align:center;}
.success{color:#00ff9c;}
.error{color:#ff5c5c;}
</style>
</head>
<body>

<header>
  <h2>MPPL Attendance – Camera Scan</h2>
</header>

<div class="center-container">
  <video id="video" autoplay muted></video>
  <canvas id="overlay"></canvas>
</div>
<div id="status" class="status">Initializing camera...</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const ctx = overlay.getContext("2d");
const statusBox = document.getElementById("status");

let labeledDescriptors = [];
let faceMatcher;
let detectionLock = false;

// ------------------------
// Voice helper
// ------------------------
function speak(msg){
  const u = new SpeechSynthesisUtterance(msg);
  speechSynthesis.speak(u);
}

// ------------------------
// Camera setup
// ------------------------
navigator.mediaDevices.getUserMedia({ video:true })
.then(stream=>{
  video.srcObject=stream;
  video.onloadedmetadata=()=>video.play();
})
.catch(()=>statusBox.innerHTML="<span class='error'>Camera access denied</span>");

// ------------------------
// Load face-api models
// ------------------------
async function loadModels(){
  try {
    await faceapi.nets.tinyFaceDetector.loadFromUri('/static/models');
    await faceapi.nets.faceLandmark68Net.loadFromUri('/static/models');
    await faceapi.nets.faceRecognitionNet.loadFromUri('/static/models');
    statusBox.innerText = "Models loaded. Loading registered faces...";
    await loadFaces();
  } catch(err){
    console.error(err);
    statusBox.innerHTML="<span class='error'>Failed to load models</span>";
  }
}

// ------------------------
// Load registered faces
// ------------------------
async function loadFaces(){
  try{
    const res = await fetch('/get_registered_faces');
    if(!res.ok) throw new Error("Failed to fetch registered faces");
    const data = await res.json();

    const options = new faceapi.TinyFaceDetectorOptions({ inputSize:512 });

    for(const emp of data){
      const img = await faceapi.fetchImage(emp.image);
      const det = await faceapi.detectSingleFace(img, options)
                    .withFaceLandmarks().withFaceDescriptor();
      if(det){
        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(emp.emp_id, [det.descriptor]));
      }
    }

    if(labeledDescriptors.length===0){
      statusBox.innerHTML="<span class='error'>No faces loaded!</span>";
      return;
    }

    faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
    statusBox.innerHTML="<span class='success'>Camera ready</span>";
    startRecognition();
  } catch(err){
    console.error(err);
    statusBox.innerHTML="<span class='error'>Error loading faces</span>";
  }
}

// ------------------------
// Recognition loop
// ------------------------
function startRecognition(){
  overlay.width = video.videoWidth;
  overlay.height = video.videoHeight;

  const options = new faceapi.TinyFaceDetectorOptions({ inputSize:512 });

  setInterval(async ()=>{
    if(video.readyState<2 || detectionLock) return;

    try{
      const detections = await faceapi.detectAllFaces(video, options)
                            .withFaceLandmarks().withFaceDescriptors();
      ctx.clearRect(0,0,overlay.width,overlay.height);

      if(detections.length!==1){
        statusBox.innerHTML="<span class='error'>Only one person allowed</span>";
        return;
      }

      const d = detections[0];
      const match = faceMatcher.findBestMatch(d.descriptor);
      const empId = match.label;

      const box=d.detection.box;
      ctx.strokeStyle=empId==="unknown"?"red":"green";
      ctx.lineWidth=2;
      ctx.strokeRect(box.x,box.y,box.width,box.height);
      ctx.fillStyle="white";
      ctx.font="16px sans-serif";
      ctx.fillText(empId, box.x, box.y-5);

      if(empId==="unknown"){
        statusBox.innerHTML="<span class='error'>Unauthorized person</span>";
        speak("Unauthorized person detected");
        return;
      }

      detectionLock = true;

      // ------------------------
      // Call backend for attendance
      // ------------------------
      const res = await fetch('/mark_attendance',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({emp_id:empId})
      });
      const data = await res.json();

      if(data.success){
        if(data.status==="Checkin"){
          statusBox.innerHTML="<span class='success'>Check-in successful</span>";
          speak("Check in successful. Have a nice day.");
        } else if(data.status==="Checkout"){
          statusBox.innerHTML="<span class='success'>Checkout successful</span>";
          speak("Thank you. Safe to reach home.");
        }
      } else {
        statusBox.innerHTML=`<span class='error'>${data.message}</span>`;
        speak(data.message);
      }

      setTimeout(()=>{ detectionLock=false; },4000);

    } catch(err){
      console.error(err);
      statusBox.innerHTML="<span class='error'>Recognition error</span>";
      detectionLock=false;
    }
  },700);
}

// ------------------------
loadModels();
</script>
</body>
</html>
